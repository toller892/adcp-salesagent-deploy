{% extends "base.html" %}

{% block title %}Users & Access - {{ tenant_name }}{% endblock %}

{% block content %}
<style>
    .users-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .page-header {
        margin-bottom: 2rem;
    }

    .page-header h1 {
        font-size: 1.75rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 0.5rem;
    }

    .page-header p {
        color: #6b7280;
    }

    .breadcrumb {
        margin-bottom: 1rem;
    }

    .breadcrumb a {
        color: #6b7280;
        text-decoration: none;
    }

    .breadcrumb a:hover {
        color: #111827;
    }

    .card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 1.5rem;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .card-header h2 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #111827;
        margin: 0;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        border: none;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
    }

    .btn-primary {
        background: #3b82f6;
        color: white;
    }

    .btn-primary:hover {
        background: #2563eb;
    }

    .btn-secondary {
        background: #f3f4f6;
        color: #374151;
    }

    .btn-secondary:hover {
        background: #e5e7eb;
    }

    .btn-danger {
        background: #fef2f2;
        color: #dc2626;
    }

    .btn-danger:hover {
        background: #fee2e2;
    }

    .btn-success {
        background: #d1fae5;
        color: #065f46;
    }

    .btn-success:hover {
        background: #a7f3d0;
    }

    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.8125rem;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 0.625rem 0.875rem;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 0.875rem;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-group .help-text {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 0.375rem;
    }

    .add-form {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
        flex-wrap: wrap;
    }

    .add-form .form-group {
        margin-bottom: 0;
        flex: 1;
        min-width: 200px;
    }

    .users-table {
        width: 100%;
        border-collapse: collapse;
    }

    .users-table th,
    .users-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
    }

    .users-table th {
        font-weight: 500;
        color: #6b7280;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        background: #f9fafb;
    }

    .users-table td {
        color: #374151;
        font-size: 0.875rem;
    }

    .users-table tr:hover td {
        background: #f9fafb;
    }

    .user-email {
        font-weight: 500;
        color: #111827;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.625rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .status-active, .status-enabled {
        background: #d1fae5;
        color: #065f46;
    }

    .status-inactive, .status-disabled {
        background: #f3f4f6;
        color: #6b7280;
    }

    .status-warning {
        background: #fef3c7;
        color: #92400e;
    }

    .user-actions {
        display: flex;
        gap: 0.5rem;
    }

    .dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        background: white;
        min-width: 150px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-radius: 8px;
        z-index: 10;
        overflow: hidden;
    }

    .dropdown:hover .dropdown-content {
        display: block;
    }

    .dropdown-content button,
    .dropdown-content a {
        display: block;
        width: 100%;
        padding: 0.625rem 1rem;
        text-align: left;
        border: none;
        background: none;
        font-size: 0.875rem;
        color: #374151;
        cursor: pointer;
        text-decoration: none;
    }

    .dropdown-content button:hover,
    .dropdown-content a:hover {
        background: #f3f4f6;
    }

    .empty-state {
        text-align: center;
        padding: 2rem 1rem;
        color: #6b7280;
    }

    .empty-state p {
        margin-bottom: 1rem;
    }

    .flash-message {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .flash-success {
        background: #d1fae5;
        color: #065f46;
    }

    .flash-error {
        background: #fef2f2;
        color: #dc2626;
    }

    .meta-text {
        font-size: 0.75rem;
        color: #9ca3af;
    }

    .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.75rem;
    }

    .tag {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.75rem;
        background: #f3f4f6;
        border-radius: 6px;
        font-size: 0.8125rem;
        color: #374151;
    }

    .tag-remove {
        cursor: pointer;
        color: #9ca3af;
        font-size: 1rem;
        line-height: 1;
    }

    .tag-remove:hover {
        color: #dc2626;
    }

    .redirect-uri-box {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .redirect-uri-box label {
        font-size: 0.75rem;
        font-weight: 500;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
        display: block;
    }

    .redirect-uri-value {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .redirect-uri-value code {
        flex: 1;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        font-size: 0.8125rem;
        font-family: monospace;
        word-break: break-all;
    }

    .button-group {
        display: flex;
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .alert {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .alert-warning {
        background: #fef3c7;
        border: 1px solid #fcd34d;
        color: #92400e;
    }

    .alert-info {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        color: #1e40af;
    }
</style>

<div class="users-container">
    <div class="breadcrumb">
        <a href="{{ url_for('tenants.dashboard', tenant_id=tenant_id) }}">{{ tenant_name }}</a>
        <span style="color: #9ca3af; margin: 0 0.5rem;">/</span>
        <a href="{{ url_for('tenants.tenant_settings', tenant_id=tenant_id) }}">Settings</a>
        <span style="color: #9ca3af; margin: 0 0.5rem;">/</span>
        <span style="color: #374151;">Users & Access</span>
    </div>

    <div class="page-header">
        <h1>Users & Access</h1>
        <p>Configure SSO and manage who can access {{ tenant_name }}</p>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash-message flash-{{ category }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Auth Setup Mode Banner -->
    {% if auth_setup_mode %}
    <div class="card" style="background: #fef3c7; border: 1px solid #fcd34d;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 style="font-size: 1rem; font-weight: 600; color: #92400e; margin-bottom: 0.25rem;">Setup Mode Active</h3>
                <p style="font-size: 0.875rem; color: #92400e; margin: 0;">
                    Test credentials are currently allowed.
                    <a href="#oidc-form" style="color: #92400e; text-decoration: underline;">Configure SSO</a> below, then disable setup mode for production use.
                    <a href="https://github.com/adcontextprotocol/salesagent/blob/main/docs/user-guide/sso-setup.md" target="_blank" style="color: #92400e; margin-left: 0.5rem;">
                        Need help?
                    </a>
                </p>
            </div>
            {% if oidc_enabled %}
            <button class="btn btn-danger" id="disable-setup-mode-btn">Disable Setup Mode</button>
            {% else %}
            <span class="status-badge status-warning">Configure SSO first</span>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="card" style="background: #d1fae5; border: 1px solid #10b981;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 style="font-size: 1rem; font-weight: 600; color: #065f46; margin-bottom: 0.25rem;">Production Mode</h3>
                <p style="font-size: 0.875rem; color: #065f46; margin: 0;">
                    Only SSO authentication is allowed. Test credentials are disabled.
                </p>
            </div>
            <button class="btn btn-secondary btn-sm" id="enable-setup-mode-btn">Re-enable Setup Mode</button>
        </div>
    </div>
    {% endif %}

    <!-- SSO Configuration -->
    <div class="card">
        <div class="card-header">
            <h2>Single Sign-On (SSO)</h2>
            <span class="status-badge" id="oidc-status-badge">Loading...</span>
        </div>

        <p style="color: #6b7280; margin-bottom: 1rem; font-size: 0.875rem;">
            Configure SSO to allow users to authenticate with your organization's identity provider (Google, Microsoft, Okta, etc.).
            <a href="https://github.com/adcontextprotocol/salesagent/blob/main/docs/user-guide/sso-setup.md" target="_blank" style="color: #4f46e5; text-decoration: none;">
                View setup guide &rarr;
            </a>
        </p>

        <div id="redirect-uri-warning" class="alert alert-warning" style="display: none;">
            <strong>Configuration Required:</strong> Your domain has changed. Please update your OAuth
            provider with the new redirect URI and re-test the connection.
        </div>

        <div class="redirect-uri-box">
            <label>Required Redirect URI</label>
            <div class="redirect-uri-value">
                <code id="redirect-uri">Loading...</code>
                <button class="btn btn-secondary btn-sm" id="copy-uri-btn" type="button">Copy</button>
            </div>
            <p class="help-text" style="margin-top: 0.5rem;">
                Configure this URI in your OAuth provider's allowed redirect URIs
            </p>
        </div>

        <form id="oidc-form">
            <div class="form-group">
                <label for="provider">Provider</label>
                <select id="provider" name="provider">
                    <option value="">Select a provider...</option>
                    <option value="google">Google</option>
                    <option value="microsoft">Microsoft</option>
                    <option value="custom">Custom OIDC</option>
                </select>
                <p class="help-text" id="provider-help" style="margin-top: 0.5rem; display: none;">
                    <a id="provider-guide-link" href="#" target="_blank" style="color: #4f46e5;">View setup guide for this provider &rarr;</a>
                </p>
            </div>

            <div id="discovery-url-group" class="form-group" style="display: none;">
                <label for="discovery_url">Discovery URL</label>
                <input type="url" id="discovery_url" name="discovery_url"
                       placeholder="https://your-idp.com/.well-known/openid-configuration">
                <p class="help-text">The OIDC discovery endpoint URL</p>
            </div>

            <div class="form-group">
                <label for="client_id">Client ID</label>
                <input type="text" id="client_id" name="client_id"
                       placeholder="your-client-id.apps.googleusercontent.com">
            </div>

            <div class="form-group">
                <label for="client_secret">Client Secret</label>
                <input type="password" id="client_secret" name="client_secret"
                       placeholder="Enter client secret">
                <p class="help-text">Your secret will be encrypted before storage</p>
            </div>

            <div id="sso-access-warning" class="alert alert-warning" style="display: none; margin-top: 1rem;">
            <strong>Before testing SSO:</strong> Add yourself as a user or add your email domain below.
            Otherwise you'll see "Access denied" after authenticating.
        </div>

        <div class="button-group">
                <button type="submit" class="btn btn-primary" id="save-oidc-btn">Save Configuration</button>
                <button type="button" class="btn btn-secondary" id="test-oidc-btn" disabled>Test Connection</button>
                <button type="button" class="btn btn-danger" id="disable-oidc-btn" style="display: none;">Deactivate SSO</button>
            </div>
        </form>
    </div>

    <!-- Add User -->
    <div class="card">
        <div class="card-header">
            <h2>Add User</h2>
        </div>

        <p style="color: #6b7280; margin-bottom: 1rem; font-size: 0.875rem;">
            Add individual users by email address. They'll be able to log in via SSO once added.
        </p>

        <form method="POST" action="{{ url_for('users.add_user', tenant_id=tenant_id) }}" class="add-form">
            <div class="form-group" style="flex: 1;">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" placeholder="user@example.com" required>
            </div>
            <input type="hidden" name="role" value="viewer">
            <button type="submit" class="btn btn-primary">Add User</button>
        </form>
        <p class="help-text" style="margin-top: 0.5rem;">Name will be populated when the user logs in via SSO.</p>
    </div>

    <!-- Allowed Domains -->
    <div class="card">
        <div class="card-header">
            <h2>Allowed Domains</h2>
        </div>

        <p style="color: #6b7280; margin-bottom: 1rem; font-size: 0.875rem;">
            Everyone from these email domains can log in via SSO. Use this to allow your entire organization.
        </p>

        <form id="add-domain-form" class="add-form">
            <div class="form-group" style="flex: 1;">
                <label for="domain">Domain</label>
                <input type="text" id="domain" name="domain" placeholder="example.com">
            </div>
            <button type="submit" class="btn btn-secondary">Add Domain</button>
        </form>

        <div class="tag-list" id="domain-list">
            {% for domain in authorized_domains %}
            <span class="tag" data-domain="{{ domain }}">
                {{ domain }}
                <span class="tag-remove" onclick="removeDomain('{{ domain }}')">&times;</span>
            </span>
            {% endfor %}
        </div>
        {% if not authorized_domains %}
        <p class="empty-state" id="no-domains-message" style="padding: 1rem;">No allowed domains configured.</p>
        {% endif %}
    </div>

    <!-- Users List -->
    <div class="card">
        <div class="card-header">
            <h2>Users ({{ users|length }})</h2>
        </div>

        {% if users %}
        <table class="users-table">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Name</th>
                    <th>Status</th>
                    <th>Last Login</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>
                        <div class="user-email">{{ user.email }}</div>
                        <div class="meta-text">Added {{ user.created_at.strftime('%b %d, %Y') if user.created_at else 'Unknown' }}</div>
                    </td>
                    <td>{{ user.name or '-' }}</td>
                    <td>
                        {% if user.is_active %}
                        <span class="status-badge status-active">Active</span>
                        {% else %}
                        <span class="status-badge status-inactive">Inactive</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.last_login %}
                        <span class="meta-text">{{ user.last_login.strftime('%b %d, %Y') }}</span>
                        {% else %}
                        <span class="meta-text">Never</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="user-actions">
                            <form method="post" action="{{ url_for('users.toggle_user', tenant_id=tenant_id, user_id=user.user_id) }}" style="display: contents;">
                                {% if user.is_active %}
                                <button type="submit" class="btn btn-danger btn-sm">Deactivate</button>
                                {% else %}
                                <button type="submit" class="btn btn-success btn-sm">Activate</button>
                                {% endif %}
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <p>No users yet. Users will appear here after logging in via SSO.</p>
        </div>
        {% endif %}
    </div>

    <!-- Info Card -->
    <div class="card" style="background: #eff6ff; border: 1px solid #bfdbfe;">
        <h3 style="font-size: 0.875rem; font-weight: 600; color: #1e40af; margin-bottom: 0.5rem;">How Access Works</h3>
        <p style="font-size: 0.875rem; color: #1e40af; line-height: 1.6; margin: 0;">
            Users from allowed domains are automatically granted access when they log in via SSO.
            You can deactivate users to revoke access without deleting them.
        </p>
    </div>
</div>

<script>
const tenantId = '{{ tenant_id }}';
const scriptRoot = '{{ request.script_root }}' || '';

// Domain management
document.getElementById('add-domain-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const domain = document.getElementById('domain').value.trim().toLowerCase();
    if (!domain) return;

    try {
        const response = await fetch(`${scriptRoot}/tenant/${tenantId}/users/domains`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ domain: domain })
        });

        const data = await response.json();
        if (data.success) {
            // Add tag to UI
            const domainList = document.getElementById('domain-list');
            const noDomainsMsg = document.getElementById('no-domains-message');
            if (noDomainsMsg) noDomainsMsg.remove();

            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.dataset.domain = domain;
            tag.innerHTML = `${domain} <span class="tag-remove" onclick="removeDomain('${domain}')">&times;</span>`;
            domainList.appendChild(tag);

            document.getElementById('domain').value = '';
        } else {
            alert(data.error || 'Failed to add domain');
        }
    } catch (err) {
        console.error('Error adding domain:', err);
        alert('Failed to add domain');
    }
});

async function removeDomain(domain) {
    if (!confirm(`Remove ${domain} from allowed domains?`)) return;

    try {
        const response = await fetch(`${scriptRoot}/tenant/${tenantId}/users/domains`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ domain: domain })
        });

        const data = await response.json();
        if (data.success) {
            // Remove tag from UI
            const tag = document.querySelector(`.tag[data-domain="${domain}"]`);
            if (tag) tag.remove();

            // Show empty message if no domains left
            const domainList = document.getElementById('domain-list');
            if (domainList.querySelectorAll('.tag').length === 0) {
                const msg = document.createElement('p');
                msg.id = 'no-domains-message';
                msg.className = 'empty-state';
                msg.style.padding = '1rem';
                msg.textContent = 'No allowed domains configured.';
                domainList.parentNode.appendChild(msg);
            }
        } else {
            alert(data.error || 'Failed to remove domain');
        }
    } catch (err) {
        console.error('Error removing domain:', err);
        alert('Failed to remove domain');
    }
}

// OIDC/SSO Management
async function loadAuthConfig() {
    try {
        const response = await fetch(`${scriptRoot}/auth/oidc/tenant/${tenantId}/config`, {
            credentials: 'same-origin'
        });
        const data = await response.json();

        // Update redirect URI
        document.getElementById('redirect-uri').textContent = data.redirect_uri || 'Not available';

        // Update status badge
        const statusBadge = document.getElementById('oidc-status-badge');
        if (data.oidc_enabled) {
            statusBadge.textContent = 'Enabled';
            statusBadge.className = 'status-badge status-enabled';
            document.getElementById('disable-oidc-btn').style.display = 'inline-flex';
        } else if (data.oidc_configured) {
            if (data.oidc_valid) {
                // SSO should auto-enable on test - this state means something went wrong
                statusBadge.textContent = 'Verified - Click Test to Enable';
                statusBadge.className = 'status-badge status-warning';
            } else {
                statusBadge.textContent = 'Not Verified';
                statusBadge.className = 'status-badge status-warning';
            }
            document.getElementById('disable-oidc-btn').style.display = 'none';
        } else {
            statusBadge.textContent = 'Not Configured';
            statusBadge.className = 'status-badge status-disabled';
            document.getElementById('disable-oidc-btn').style.display = 'none';
        }

        // Show warning if redirect URI changed
        if (data.redirect_uri_changed) {
            document.getElementById('redirect-uri-warning').style.display = 'block';
        }

        // Populate form fields
        if (data.config) {
            document.getElementById('provider').value = data.config.provider || '';
            document.getElementById('client_id').value = data.config.client_id || '';
            document.getElementById('discovery_url').value = data.config.discovery_url || '';

            // Show indicator if client secret is saved
            const secretField = document.getElementById('client_secret');
            if (data.config.has_client_secret) {
                secretField.placeholder = '••••••••••••••••  (secret saved - leave empty to keep)';
            } else {
                secretField.placeholder = 'Enter client secret';
            }

            // Show discovery URL field for custom provider
            if (data.config.provider === 'custom') {
                document.getElementById('discovery-url-group').style.display = 'block';
            }

            // Enable test button if we have config
            if (data.config.client_id) {
                document.getElementById('test-oidc-btn').disabled = false;
            }
        }

        // Update SSO access warning
        updateSsoAccessWarning(data.oidc_configured);
    } catch (err) {
        console.error('Failed to load auth config:', err);
        document.getElementById('oidc-status-badge').textContent = 'Error';
        document.getElementById('oidc-status-badge').className = 'status-badge status-disabled';
    }
}

// Provider change handler
document.getElementById('provider').addEventListener('change', function() {
    const discoveryGroup = document.getElementById('discovery-url-group');
    const providerHelp = document.getElementById('provider-help');
    const providerGuideLink = document.getElementById('provider-guide-link');

    // Show/hide discovery URL for custom provider
    if (this.value === 'custom') {
        discoveryGroup.style.display = 'block';
    } else {
        discoveryGroup.style.display = 'none';
    }

    // Update provider-specific help link
    const guideBase = 'https://github.com/adcontextprotocol/salesagent/blob/main/docs/user-guide/sso-setup.md';
    const providerAnchors = {
        'google': '#google-workspace',
        'microsoft': '#microsoft-entra-id-azure-ad',
        'custom': '#quick-start'
    };

    if (this.value && providerAnchors[this.value]) {
        providerHelp.style.display = 'block';
        providerGuideLink.href = guideBase + providerAnchors[this.value];
    } else {
        providerHelp.style.display = 'none';
    }
});

// Copy redirect URI
document.getElementById('copy-uri-btn').addEventListener('click', function() {
    const uri = document.getElementById('redirect-uri').textContent;
    navigator.clipboard.writeText(uri).then(() => {
        this.textContent = 'Copied!';
        setTimeout(() => { this.textContent = 'Copy'; }, 2000);
    });
});

// Save OIDC config
document.getElementById('oidc-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const config = {
        provider: document.getElementById('provider').value,
        client_id: document.getElementById('client_id').value,
        client_secret: document.getElementById('client_secret').value,
        discovery_url: document.getElementById('discovery_url').value
    };

    try {
        const response = await fetch(`${scriptRoot}/auth/oidc/tenant/${tenantId}/config`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify(config)
        });

        const data = await response.json();
        if (data.success) {
            alert('Configuration saved');
            document.getElementById('test-oidc-btn').disabled = false;
            loadAuthConfig();
        } else {
            alert(data.error || 'Failed to save configuration');
        }
    } catch (err) {
        console.error('Error saving config:', err);
        alert('Failed to save configuration');
    }
});

// Test OIDC connection - navigate directly (OAuth redirects don't work with fetch due to CORS)
document.getElementById('test-oidc-btn').addEventListener('click', function() {
    window.location.href = `${scriptRoot}/auth/oidc/test/${tenantId}`;
});

// Deactivate SSO
document.getElementById('disable-oidc-btn').addEventListener('click', async function() {
    if (!confirm('Deactivate SSO? Users will not be able to log in via SSO until you re-enable it.')) return;

    try {
        const response = await fetch(`${scriptRoot}/auth/oidc/tenant/${tenantId}/disable`, {
            method: 'POST',
            credentials: 'same-origin'
        });
        const data = await response.json();

        if (data.success) {
            alert('SSO deactivated');
            loadAuthConfig();
        } else {
            alert(data.error || 'Failed to deactivate SSO');
        }
    } catch (err) {
        console.error('Error deactivating SSO:', err);
        alert('Failed to deactivate SSO');
    }
});

// Disable setup mode
const disableSetupBtn = document.getElementById('disable-setup-mode-btn');
if (disableSetupBtn) {
    disableSetupBtn.addEventListener('click', async function() {
        if (!confirm('Disable setup mode? Test credentials will no longer work and only SSO authentication will be allowed.')) return;

        try {
            const response = await fetch(`${scriptRoot}/tenant/${tenantId}/users/disable-setup-mode`, {
                method: 'POST',
                credentials: 'same-origin'
            });
            const data = await response.json();

            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                alert(data.error || 'Failed to disable setup mode');
            }
        } catch (err) {
            console.error('Error disabling setup mode:', err);
            alert('Failed to disable setup mode');
        }
    });
}

// Enable setup mode
const enableSetupBtn = document.getElementById('enable-setup-mode-btn');
if (enableSetupBtn) {
    enableSetupBtn.addEventListener('click', async function() {
        if (!confirm('Re-enable setup mode? This allows test credentials to work again.')) return;

        try {
            const response = await fetch(`${scriptRoot}/tenant/${tenantId}/users/enable-setup-mode`, {
                method: 'POST',
                credentials: 'same-origin'
            });
            const data = await response.json();

            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                alert(data.error || 'Failed to enable setup mode');
            }
        } catch (err) {
            console.error('Error enabling setup mode:', err);
            alert('Failed to enable setup mode');
        }
    });
}

// Show SSO access warning if configured but no users/domains
function updateSsoAccessWarning(oidcConfigured) {
    const warning = document.getElementById('sso-access-warning');
    const hasUsers = {{ users|length }} > 0;
    const hasDomains = {{ authorized_domains|length }} > 0;

    if (oidcConfigured && !hasUsers && !hasDomains) {
        warning.style.display = 'block';
    } else {
        warning.style.display = 'none';
    }
}

// Initialize
loadAuthConfig();
</script>
{% endblock %}
