{% extends "base.html" %}

{% block title %}Orders - {{ tenant_name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2>GAM Orders - {{ tenant_name }}</h2>

            <!-- Quick Line Item Search -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="input-group">
                                <input type="text" class="form-control" id="lineItemIdSearch" placeholder="Enter Line Item ID to view details...">
                                <button class="btn btn-outline-primary" onclick="searchLineItem()">
                                    <i class="bi bi-search"></i> View Line Item
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <small class="text-muted">Tip: You can also click "Details" on any line item below</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sync Controls -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div id="lastSyncInfo">
                                <span class="text-muted">Loading sync status...</span>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary" id="syncButton" onclick="syncOrders()">
                                <i class="bi bi-arrow-clockwise"></i> Sync Orders
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchInput" placeholder="Search orders...">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="statusFilter">
                                <option value="">All Statuses</option>
                                <option value="DRAFT">Draft</option>
                                <option value="PENDING_APPROVAL">Pending Approval</option>
                                <option value="APPROVED">Approved</option>
                                <option value="DELIVERING">Delivering</option>
                                <option value="READY">Ready</option>
                                <option value="PAUSED">Paused</option>
                                <option value="CANCELED">Canceled</option>
                                <option value="COMPLETED">Completed</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="advertiserFilter">
                                <option value="">All Advertisers</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="lineItemsFilter">
                                <option value="">All Orders</option>
                                <option value="true">With Line Items</option>
                                <option value="false">Without Line Items</option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <button class="btn btn-secondary w-100" onclick="applyFilters()">Apply</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orders Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="ordersTable">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Name</th>
                                    <th>Advertiser</th>
                                    <th>Delivery Status</th>
                                    <th>Progress</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Budget</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <tr>
                                    <td colspan="9" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetailsBody">
                <!-- Details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
let currentOrders = [];
const tenantId = '{{ tenant_id }}';

// Load orders on page load
document.addEventListener('DOMContentLoaded', function() {
    loadOrders();
    loadAdvertisers();
});

function applyFilters() {
    loadOrders();
}

function searchLineItem() {
    const lineItemId = document.getElementById('lineItemIdSearch').value.trim();
    if (!lineItemId) {
        alert('Please enter a Line Item ID');
        return;
    }

    // Open the line item viewer in a new tab
    window.open(`/tenant/${tenantId}/gam/line-item/${lineItemId}`, '_blank');
}

function loadOrders() {
    const searchTerm = document.getElementById('searchInput').value;
    const status = document.getElementById('statusFilter').value;
    const advertiserId = document.getElementById('advertiserFilter').value;
    const hasLineItems = document.getElementById('lineItemsFilter').value;

    let url = `/api/tenant/${tenantId}/orders?`;
    if (searchTerm) url += `search=${encodeURIComponent(searchTerm)}&`;
    if (status) url += `status=${encodeURIComponent(status)}&`;
    if (advertiserId) url += `advertiser_id=${encodeURIComponent(advertiserId)}&`;
    if (hasLineItems) url += `has_line_items=${encodeURIComponent(hasLineItems)}&`;

    fetch(url, {
        credentials: 'same-origin'  // Include session cookies
    })
    .then(response => response.json())
    .then(data => {
        currentOrders = data.orders || [];
        displayOrders(currentOrders);
    })
    .catch(error => {
        console.error('Error loading orders:', error);
        document.getElementById('ordersTableBody').innerHTML =
            '<tr><td colspan="9" class="text-center text-danger">Error loading orders</td></tr>';
    });
}

function displayOrders(orders) {
    const tbody = document.getElementById('ordersTableBody');

    if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center">No orders found</td></tr>';
        return;
    }

    tbody.innerHTML = orders.map(order => {
        const deliveryStatus = order.delivery_status || order.status;
        const deliveryMetrics = order.delivery_metrics || {};
        const deliveryPercentage = deliveryMetrics.delivery_percentage || 0;
        const hasLineItems = order.line_item_count > 0;

        let progressBar = '';
        if (hasLineItems && deliveryMetrics.total_impressions_goal > 0) {
            progressBar = `
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar" role="progressbar" style="width: ${Math.min(deliveryPercentage, 100)}%"
                         aria-valuenow="${deliveryPercentage}" aria-valuemin="0" aria-valuemax="100">
                        ${deliveryPercentage.toFixed(1)}%
                    </div>
                </div>
                <small class="text-muted">${formatNumber(deliveryMetrics.total_impressions_delivered)} / ${formatNumber(deliveryMetrics.total_impressions_goal)}</small>
            `;
        } else if (!hasLineItems) {
            progressBar = '<span class="text-muted">No line items</span>';
        } else {
            progressBar = `<span class="text-muted">${order.line_item_count} line item${order.line_item_count > 1 ? 's' : ''}</span>`;
        }

        return `
            <tr>
                <td>${order.order_id}</td>
                <td>${order.name}</td>
                <td>${order.advertiser_name || order.advertiser_id || '-'}</td>
                <td><span class="badge bg-${getDeliveryStatusColor(deliveryStatus)}">${formatDeliveryStatus(deliveryStatus)}</span></td>
                <td>${progressBar}</td>
                <td>${formatDate(order.start_date)}</td>
                <td>${order.unlimited_end_date ? 'Unlimited' : formatDate(order.end_date)}</td>
                <td>${formatCurrency(order.budget || order.total_budget, order.currency_code)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails('${order.order_id}')">
                        <i class="bi bi-eye"></i> View
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function getStatusColor(status) {
    const colors = {
        'DRAFT': 'secondary',
        'PENDING_APPROVAL': 'warning',
        'APPROVED': 'success',
        'PAUSED': 'info',
        'CANCELED': 'danger',
        'DELETED': 'dark'
    };
    return colors[status] || 'secondary';
}

function getDeliveryStatusColor(status) {
    const colors = {
        'DELIVERING': 'success',
        'READY': 'info',
        'COMPLETED': 'secondary',
        'PAUSED': 'warning',
        'DRAFT': 'light',
        'NO_LINE_ITEMS': 'light',
        'APPROVED': 'primary'
    };
    return colors[status] || 'secondary';
}

function formatDeliveryStatus(status) {
    const labels = {
        'DELIVERING': 'Delivering',
        'READY': 'Ready',
        'COMPLETED': 'Completed',
        'PAUSED': 'Paused',
        'DRAFT': 'Draft',
        'NO_LINE_ITEMS': 'No Line Items',
        'APPROVED': 'Approved'
    };
    return labels[status] || status;
}

function formatNumber(num) {
    if (num === null || num === undefined) return '0';
    return new Intl.NumberFormat('en-US').format(num);
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString();
}

function formatCurrency(amount, currency) {
    if (amount === null || amount === undefined) return '-';
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: currency || 'USD'
    }).format(amount);
}

function viewOrderDetails(orderId) {
    fetch(`{{ script_name }}/api/tenant/${tenantId}/orders/${orderId}`, {
        credentials: 'same-origin'  // Include session cookies
    })
    .then(response => response.json())
    .then(data => {
        // API returns data nested under 'order' property
        const order = data.order || data;
        // Attach line_items from the response
        order.line_items = data.line_items || [];
        displayOrderDetails(order);
        const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
        modal.show();
    })
    .catch(error => {
        console.error('Error loading order details:', error);
        alert('Failed to load order details');
    });
}

function displayOrderDetails(order) {
    const detailsBody = document.getElementById('orderDetailsBody');

    // Calculate line items stats
    const activeLineItems = (order.line_items || []).filter(li => li.status === 'APPROVED').length;
    const totalLineItems = (order.line_items || []).length;

    const deliveryMetrics = order.delivery_metrics || {};
    const deliveryStatus = order.delivery_status || order.status;

    detailsBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Order Information</h6>
                <table class="table table-sm">
                    <tr><th>Order ID:</th><td>${order.order_id}</td></tr>
                    <tr><th>Name:</th><td>${order.name}</td></tr>
                    <tr><th>Order Status:</th><td><span class="badge bg-${getStatusColor(order.status)}">${order.status}</span></td></tr>
                    <tr><th>Delivery Status:</th><td><span class="badge bg-${getDeliveryStatusColor(deliveryStatus)}">${formatDeliveryStatus(deliveryStatus)}</span></td></tr>
                    <tr><th>PO Number:</th><td>${order.po_number || order.external_order_id || '-'}</td></tr>
                    <tr><th>Total Budget:</th><td>${formatCurrency(order.budget || order.total_budget, order.currency_code)}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Dates & Contacts</h6>
                <table class="table table-sm">
                    <tr><th>Start Date:</th><td>${formatDate(order.start_date)}</td></tr>
                    <tr><th>End Date:</th><td>${order.unlimited_end_date ? 'Unlimited' : formatDate(order.end_date)}</td></tr>
                    <tr><th>Advertiser:</th><td>${order.advertiser_name || '-'}</td></tr>
                    <tr><th>Agency:</th><td>${order.agency_name || '-'}</td></tr>
                    <tr><th>Salesperson:</th><td>${order.salesperson_name || '-'}</td></tr>
                </table>
            </div>
        </div>

        <hr>

        <div class="row">
            <div class="col-12">
                <h6>Delivery Metrics</h6>
                <div class="row text-center">
                    <div class="col-md-2">
                        <div class="card">
                            <div class="card-body">
                                <h5>${totalLineItems}</h5>
                                <small class="text-muted">Line Items</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5>${formatNumber(deliveryMetrics.total_impressions_delivered || 0)}</h5>
                                <small class="text-muted">Impressions Delivered</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5>${formatNumber(deliveryMetrics.total_impressions_goal || 0)}</h5>
                                <small class="text-muted">Impressions Goal</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card">
                            <div class="card-body">
                                <h5>${(deliveryMetrics.delivery_percentage || 0).toFixed(1)}%</h5>
                                <small class="text-muted">Delivered</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card">
                            <div class="card-body">
                                <h5>${formatCurrency(deliveryMetrics.estimated_spend || 0, order.currency_code)}</h5>
                                <small class="text-muted">Est. Spend</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hr>

        <div class="row">
            <div class="col-12">
                <h6>Line Items (${totalLineItems})</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Priority</th>
                                <th>Goal</th>
                                <th>Delivered</th>
                                <th>Progress</th>
                                <th>CPM</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(order.line_items || []).map(li => {
                                const liDeliveryPercentage = li.delivery_percentage || 0;
                                return `
                                <tr>
                                    <td>${li.line_item_id}</td>
                                    <td>${li.name}</td>
                                    <td>${li.line_item_type}</td>
                                    <td><span class="badge bg-${getDeliveryStatusColor(li.status)}">${li.status}</span></td>
                                    <td>${li.priority || '-'}</td>
                                    <td>${li.primary_goal_units ? formatNumber(li.primary_goal_units) : '-'}</td>
                                    <td>${li.stats_impressions ? formatNumber(li.stats_impressions) : '0'}</td>
                                    <td>${liDeliveryPercentage.toFixed(1)}%</td>
                                    <td>${li.cost_per_unit ? '$' + li.cost_per_unit.toFixed(2) : '-'}</td>
                                    <td>
                                        <a href="/tenant/${tenantId}/gam/line-item/${li.line_item_id}"
                                           class="btn btn-sm btn-outline-info"
                                           target="_blank"
                                           title="View full line item details including targeting, creatives, and JSON representation">
                                            <i class="bi bi-box-arrow-up-right"></i> Details
                                        </a>
                                    </td>
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

function syncOrders() {
    const syncButton = document.getElementById('syncButton');
    syncButton.disabled = true;
    syncButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Syncing...';

    // Try session-based authentication first, fall back to API key if available
    const headers = {
        'Content-Type': 'application/json'
    };

    // Only add API key if it exists and is not empty
    const apiKey = {{ api_key|tojson|safe }};
    if (apiKey && apiKey !== '') {
        headers['X-API-Key'] = apiKey;
    }

    fetch(`{{ script_name }}/api/tenant/${tenantId}/sync/orders`, {
        method: 'POST',
        credentials: 'same-origin',  // Include session cookies
        headers: headers
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'completed') {
            const orderCount = data.summary?.orders?.total || 0;
            const lineItemCount = data.summary?.line_items?.total || 0;
            alert(`Sync completed! Synced ${orderCount} orders and ${lineItemCount} line items.`);
            loadOrders();
        } else {
            alert('Sync failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error syncing orders:', error);
        alert('Failed to sync orders');
    })
    .finally(() => {
        syncButton.disabled = false;
        syncButton.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Sync Orders';
    });
}

function loadAdvertisers() {
    // Extract unique advertisers from current orders
    const advertisers = new Set();
    currentOrders.forEach(order => {
        if (order.advertiser_name) {
            advertisers.add(JSON.stringify({
                id: order.advertiser_id,
                name: order.advertiser_name
            }));
        }
    });

    const advertiserSelect = document.getElementById('advertiserFilter');
    advertiserSelect.innerHTML = '<option value="">All Advertisers</option>';

    Array.from(advertisers).forEach(advertiserStr => {
        const advertiser = JSON.parse(advertiserStr);
        const option = document.createElement('option');
        option.value = advertiser.id;
        option.textContent = advertiser.name;
        advertiserSelect.appendChild(option);
    });
}

function applyFilters() {
    loadOrders();
}
</script>
{% endblock %}
