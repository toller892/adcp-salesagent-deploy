{% extends "base.html" %}

{% block title %}
{{ "Edit" if mode == "edit" else "Create" }} Property - {{ tenant.name }}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>{{ "Edit" if mode == "edit" else "Create" }} Authorized Property</h2>
                <a href="{{ url_for('inventory.inventory_browser', tenant_id=tenant.tenant_id) }}#publishers-tab"
                   class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Publishers & Properties
                </a>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-building"></i>
                                Property Details
                            </h5>
                        </div>
                        <div class="card-body">
                            <form method="POST" id="property-form">
                                <!-- Property Type -->
                                <div class="mb-3">
                                    <label for="property_type" class="form-label">Property Type <span class="text-danger">*</span></label>
                                    <select class="form-select" id="property_type" name="property_type" required>
                                        <option value="">Select property type...</option>
                                        <option value="website" {{ "selected" if property and property.property_type == "website" }}>Website</option>
                                        <option value="mobile_app" {{ "selected" if property and property.property_type == "mobile_app" }}>Mobile App</option>
                                        <option value="ctv_app" {{ "selected" if property and property.property_type == "ctv_app" }}>CTV App</option>
                                        <option value="dooh" {{ "selected" if property and property.property_type == "dooh" }}>DOOH</option>
                                        <option value="podcast" {{ "selected" if property and property.property_type == "podcast" }}>Podcast</option>
                                        <option value="radio" {{ "selected" if property and property.property_type == "radio" }}>Radio</option>
                                        <option value="streaming_audio" {{ "selected" if property and property.property_type == "streaming_audio" }}>Streaming Audio</option>
                                    </select>
                                </div>

                                <!-- Property Name -->
                                <div class="mb-3">
                                    <label for="name" class="form-label">Property Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="name" name="name"
                                           value="{{ property.name if property else '' }}"
                                           placeholder="e.g., Sports News Website"
                                           required>
                                </div>

                                <!-- Publisher Domain -->
                                <div class="mb-3">
                                    <label for="publisher_domain" class="form-label">Publisher Domain <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="publisher_domain" name="publisher_domain"
                                           value="{{ property.publisher_domain if property else '' }}"
                                           placeholder="e.g., example.com"
                                           required>
                                    <div class="form-text">Domain where adagents.json will be checked for verification</div>
                                </div>

                                <!-- Identifiers Section -->
                                <div class="mb-4">
                                    <label class="form-label">Identifiers <span class="text-danger">*</span></label>
                                    <div class="border rounded p-3 bg-light">
                                        <div id="identifiers-container">
                                            {% if property and property.identifiers %}
                                                {% for identifier in property.identifiers %}
                                                <div class="identifier-row mb-2" data-index="{{ loop.index0 }}">
                                                    <div class="row">
                                                        <div class="col-md-4">
                                                            <input type="text" class="form-control"
                                                                   name="identifier_type_{{ loop.index0 }}"
                                                                   value="{{ identifier.type }}"
                                                                   placeholder="Type (e.g., domain, bundle_id)">
                                                        </div>
                                                        <div class="col-md-6">
                                                            <input type="text" class="form-control"
                                                                   name="identifier_value_{{ loop.index0 }}"
                                                                   value="{{ identifier.value }}"
                                                                   placeholder="Value (e.g., example.com)">
                                                        </div>
                                                        <div class="col-md-2">
                                                            <button type="button" class="btn btn-outline-danger btn-sm remove-identifier"
                                                                    {% if loop.index0 == 0 %}style="display: none;"{% endif %}>
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            {% else %}
                                                <div class="identifier-row mb-2" data-index="0">
                                                    <div class="row">
                                                        <div class="col-md-4">
                                                            <input type="text" class="form-control"
                                                                   name="identifier_type_0"
                                                                   placeholder="Type (e.g., domain, bundle_id)">
                                                        </div>
                                                        <div class="col-md-6">
                                                            <input type="text" class="form-control"
                                                                   name="identifier_value_0"
                                                                   placeholder="Value (e.g., example.com)">
                                                        </div>
                                                        <div class="col-md-2">
                                                            <button type="button" class="btn btn-outline-danger btn-sm remove-identifier" style="display: none;">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <button type="button" class="btn btn-outline-primary btn-sm" id="add-identifier">
                                            <i class="fas fa-plus"></i> <span id="add-identifier-text">Add Identifier</span>
                                        </button>
                                        <div class="form-text">
                                            <strong>Website properties:</strong> The main domain is automatically added and cannot be removed. You can add subdomains as additional identifiers.<br>
                                            <strong>Other properties:</strong> Select appropriate identifier types from the dropdown. At least one identifier is required.
                                        </div>
                                    </div>
                                </div>

                                <!-- Tags Section -->
                                <div class="mb-4">
                                    <label class="form-label">Tags</label>
                                    <!-- Hidden input to ensure all_inventory is always submitted -->
                                    <input type="hidden" name="tags" value="all_inventory">
                                    <div class="border rounded p-3 bg-light">
                                        {% if existing_tags %}
                                            {% for tag in existing_tags %}
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       name="tags" value="{{ tag.tag_id }}"
                                                       id="tag_{{ tag.tag_id }}"
                                                       {% if property and property.tags and tag.tag_id in property.tags %}checked{% endif %}
                                                       {% if tag.tag_id == 'all_inventory' %}checked disabled{% endif %}>
                                                <label class="form-check-label" for="tag_{{ tag.tag_id }}"{% if tag.tag_id == 'all_inventory' %} style="opacity: 0.7;"{% endif %}>
                                                    <strong>{{ tag.name }}</strong>
                                                    <small class="text-muted">- {{ tag.description }}</small>
                                                    {% if tag.tag_id == 'all_inventory' %}<span class="badge bg-secondary ms-2">Required</span>{% endif %}
                                                </label>
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                            <div class="text-muted">
                                                <i class="fas fa-info-circle"></i>
                                                No tags have been created yet.
                                                <a href="{{ url_for('authorized_properties.list_property_tags', tenant_id=tenant.tenant_id) }}">
                                                    Create tags
                                                </a> to categorize your properties.
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <div class="d-flex justify-content-between">
                                    <a href="{{ url_for('inventory.inventory_browser', tenant_id=tenant.tenant_id) }}#publishers-tab"
                                       class="btn btn-outline-secondary">
                                        Cancel
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i>
                                        {{ "Update Property" if mode == "edit" else "Create Property" }}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Help Sidebar -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-question-circle"></i>
                                Property Guidelines
                            </h6>
                        </div>
                        <div class="card-body">
                            <h6>Property Types</h6>
                            <ul class="small">
                                <li><strong>Website:</strong> Web-based properties</li>
                                <li><strong>Mobile App:</strong> iOS/Android applications</li>
                                <li><strong>CTV App:</strong> Connected TV applications</li>
                                <li><strong>DOOH:</strong> Digital out-of-home displays</li>
                                <li><strong>Podcast:</strong> Audio podcast content</li>
                                <li><strong>Radio:</strong> Traditional/digital radio</li>
                                <li><strong>Streaming Audio:</strong> Music/audio platforms</li>
                            </ul>

                            <h6 class="mt-3">Identifier Types (AdCP Official)</h6>
                            <ul class="small">
                                <li><strong>domain:</strong> Web domain (example.com)</li>
                                <li><strong>subdomain:</strong> Specific subdomain (news.example.com)</li>
                                <li><strong>ios_bundle:</strong> iOS bundle ID</li>
                                <li><strong>android_package:</strong> Android package name</li>
                                <li><strong>roku_store_id:</strong> Roku channel store ID</li>
                                <li><strong>fire_tv_asin:</strong> Amazon Fire TV ASIN</li>
                                <li><strong>podcast_guid:</strong> Podcast GUID identifier</li>
                                <li><strong>apple_podcast_id:</strong> Apple Podcasts ID</li>
                                <li><strong>spotify_show_id:</strong> Spotify show identifier</li>
                                <li><strong>venue_id:</strong> DOOH venue identifier</li>
                                <li><strong>screen_id:</strong> DOOH screen identifier</li>
                                <li><strong>openooh_venue_type:</strong> OpenOOH venue classification</li>
                            </ul>

                            <h6 class="mt-3">Domain Matching</h6>
                            <p class="small">
                                For domain identifiers:
                            </p>
                            <ul class="small">
                                <li><code>example.com</code> matches www.example.com and m.example.com</li>
                                <li><code>*.example.com</code> matches all subdomains</li>
                                <li><code>subdomain.example.com</code> matches specific subdomain only</li>
                            </ul>

                            <h6 class="mt-3">Verification</h6>
                            <p class="small">
                                Properties are verified by checking the publisher domain's
                                <code>/.well-known/adagents.json</code> file for your agent URL.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let identifierCount = {{ (property.identifiers | length) if property and property.identifiers else 1 }};

    // Official AdCP identifier types (from PR #75)
    const identifierTypeMap = {
        'website': [
            { value: 'domain', label: 'Domain', placeholder: 'example.com' },
            { value: 'subdomain', label: 'Subdomain', placeholder: 'news.example.com' }
        ],
        'mobile_app': [
            { value: 'ios_bundle', label: 'iOS Bundle ID', placeholder: 'com.example.app' },
            { value: 'android_package', label: 'Android Package', placeholder: 'com.example.app' },
            { value: 'apple_app_store_id', label: 'Apple App Store ID', placeholder: '123456789' },
            { value: 'google_play_id', label: 'Google Play ID', placeholder: 'com.example.app' },
            { value: 'bundle_id', label: 'Bundle ID (Generic)', placeholder: 'com.example.app' }
        ],
        'ctv_app': [
            { value: 'roku_store_id', label: 'Roku Store ID', placeholder: 'dev_123456' },
            { value: 'fire_tv_asin', label: 'Fire TV ASIN', placeholder: 'B01234567' },
            { value: 'samsung_app_id', label: 'Samsung App ID', placeholder: 'app_id_123' },
            { value: 'apple_tv_bundle', label: 'Apple TV Bundle', placeholder: 'com.example.tvapp' }
        ],
        'dooh': [
            { value: 'venue_id', label: 'Venue ID', placeholder: 'venue_123' },
            { value: 'screen_id', label: 'Screen ID', placeholder: 'screen_456' },
            { value: 'network_id', label: 'Network ID', placeholder: 'network_789' },
            { value: 'openooh_venue_type', label: 'OpenOOH Venue Type', placeholder: 'retail_mall' }
        ],
        'podcast': [
            { value: 'podcast_guid', label: 'Podcast GUID', placeholder: 'podcast-guid-123' },
            { value: 'rss_url', label: 'RSS URL', placeholder: 'https://feeds.example.com/podcast.xml' },
            { value: 'apple_podcast_id', label: 'Apple Podcast ID', placeholder: 'id123456789' },
            { value: 'spotify_show_id', label: 'Spotify Show ID', placeholder: '4abc5def6ghi7jkl8' }
        ],
        'radio': [
            { value: 'network_id', label: 'Network ID', placeholder: 'network_radio_123' }
        ],
        'streaming_audio': [
            { value: 'spotify_show_id', label: 'Spotify Show ID', placeholder: '4abc5def6ghi7jkl8' },
            { value: 'apple_podcast_id', label: 'Apple Podcast ID', placeholder: 'id123456789' },
            { value: 'rss_url', label: 'RSS URL', placeholder: 'https://feeds.example.com/audio.xml' }
        ]
    };

    function updateIdentifierOptions() {
        const propertyType = document.getElementById('property_type').value;
        const publisherDomain = document.getElementById('publisher_domain').value;
        const identifierRows = document.querySelectorAll('.identifier-row');
        const addButtonText = document.getElementById('add-identifier-text');

        if (propertyType === 'website') {
            // Special handling for website properties
            updateWebsiteIdentifiers(publisherDomain);
            addButtonText.textContent = 'Add Subdomain';
        } else {
            // Standard handling for other property types
            identifierRows.forEach(row => {
                updateIdentifierRow(row, propertyType);
            });
            addButtonText.textContent = 'Add Identifier';
        }
    }

    function updateWebsiteIdentifiers(publisherDomain) {
        const container = document.getElementById('identifiers-container');
        const existingRows = container.querySelectorAll('.identifier-row');

        // Clear existing rows
        existingRows.forEach(row => row.remove());

        // Always add the main domain identifier (non-removable)
        const mainDomainRow = createWebsiteDomainRow(publisherDomain, 0, false);
        container.appendChild(mainDomainRow);

        // Add any existing subdomain identifiers or one empty subdomain row
        let subdomainCount = 1;
        {% if property and property.identifiers %}
            {% for identifier in property.identifiers %}
                {% if identifier.type == 'subdomain' %}
                    const subdomainRow = createWebsiteSubdomainRow('{{ identifier.value }}', subdomainCount, true);
                    container.appendChild(subdomainRow);
                    subdomainCount++;
                {% endif %}
            {% endfor %}
        {% endif %}

        // If no subdomains exist, add one empty subdomain row
        if (subdomainCount === 1) {
            const emptySubdomainRow = createWebsiteSubdomainRow('', 1, true);
            container.appendChild(emptySubdomainRow);
        }

        identifierCount = subdomainCount + 1;
        updateRemoveButtons();
    }

    function createWebsiteDomainRow(domain, index, removable) {
        const row = document.createElement('div');
        row.className = 'identifier-row mb-2';
        row.setAttribute('data-index', index);

        row.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <input type="hidden" name="identifier_type_${index}" value="domain">
                    <input type="text" class="form-control" value="Domain (Main)" readonly>
                </div>
                <div class="col-md-6">
                    <input type="hidden" name="identifier_value_${index}" value="${domain}">
                    <input type="text" class="form-control" value="${domain}" readonly>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm" disabled title="Main domain is required">
                        <i class="fas fa-lock"></i>
                    </button>
                </div>
            </div>
        `;

        return row;
    }

    function createWebsiteSubdomainRow(value, index, removable) {
        const row = document.createElement('div');
        row.className = 'identifier-row mb-2';
        row.setAttribute('data-index', index);

        row.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <input type="hidden" name="identifier_type_${index}" value="subdomain">
                    <input type="text" class="form-control" value="Subdomain" readonly>
                </div>
                <div class="col-md-6">
                    <input type="text" class="form-control" name="identifier_value_${index}"
                           value="${value}" placeholder="news.example.com">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-identifier"
                            style="${removable ? 'display: block;' : 'display: none;'}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;

        return row;
    }

    function updateIdentifierRow(row, propertyType) {
        const typeInput = row.querySelector('input[name^="identifier_type_"]');
        const valueInput = row.querySelector('input[name^="identifier_value_"]');

        if (typeInput && propertyType && identifierTypeMap[propertyType]) {
            // Convert to select dropdown
            const select = document.createElement('select');
            select.className = 'form-control';
            select.name = typeInput.name;

            // Add placeholder option
            const placeholderOption = document.createElement('option');
            placeholderOption.value = '';
            placeholderOption.textContent = 'Select identifier type...';
            select.appendChild(placeholderOption);

            // Add options for this property type
            identifierTypeMap[propertyType].forEach(identType => {
                const option = document.createElement('option');
                option.value = identType.value;
                option.textContent = identType.label;
                if (typeInput.value === identType.value) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            // Update placeholder for value input
            select.addEventListener('change', function() {
                const selectedType = identifierTypeMap[propertyType].find(t => t.value === this.value);
                if (selectedType && valueInput) {
                    valueInput.placeholder = selectedType.placeholder;
                }
            });

            typeInput.parentNode.replaceChild(select, typeInput);

            // Trigger change to set initial placeholder
            if (select.value) {
                select.dispatchEvent(new Event('change'));
            }
        }
    }

    // Property type change handler
    document.getElementById('property_type').addEventListener('change', updateIdentifierOptions);

    // Publisher domain change handler
    document.getElementById('publisher_domain').addEventListener('blur', function() {
        const propertyType = document.getElementById('property_type').value;
        if (propertyType === 'website') {
            updateIdentifierOptions();
        }
    });

    // Add identifier functionality
    document.getElementById('add-identifier').addEventListener('click', function() {
        const container = document.getElementById('identifiers-container');
        const propertyType = document.getElementById('property_type').value;

        if (propertyType === 'website') {
            // For websites, only add subdomain identifiers
            const newRow = createWebsiteSubdomainRow('', identifierCount, true);
            container.appendChild(newRow);
        } else {
            // Standard identifier addition for other property types
            const newRow = document.createElement('div');
            newRow.className = 'identifier-row mb-2';
            newRow.setAttribute('data-index', identifierCount);

            let typeField = '';
            if (propertyType && identifierTypeMap[propertyType]) {
                typeField = `<select class="form-control" name="identifier_type_${identifierCount}">
                    <option value="">Select identifier type...</option>`;
                identifierTypeMap[propertyType].forEach(identType => {
                    typeField += `<option value="${identType.value}">${identType.label}</option>`;
                });
                typeField += '</select>';
            } else {
                typeField = `<input type="text" class="form-control"
                           name="identifier_type_${identifierCount}"
                           placeholder="Type (e.g., domain, bundle_id)">`;
            }

            newRow.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        ${typeField}
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control"
                               name="identifier_value_${identifierCount}"
                               placeholder="Value">
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-identifier">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;

            container.appendChild(newRow);

            // Add change handler for new select
            const newSelect = newRow.querySelector('select');
            const newValueInput = newRow.querySelector('input[name^="identifier_value_"]');
            if (newSelect && newValueInput) {
                newSelect.addEventListener('change', function() {
                    const selectedType = identifierTypeMap[propertyType].find(t => t.value === this.value);
                    if (selectedType) {
                        newValueInput.placeholder = selectedType.placeholder;
                    }
                });
            }
        }

        identifierCount++;
        updateRemoveButtons();
    });

    // Remove identifier functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-identifier') || e.target.parentElement.classList.contains('remove-identifier')) {
            const row = e.target.closest('.identifier-row');
            row.remove();
            renumberIdentifiers();
            updateRemoveButtons();
        }
    });

    function renumberIdentifiers() {
        const rows = document.querySelectorAll('.identifier-row');
        rows.forEach((row, index) => {
            // Update data-index attribute
            row.setAttribute('data-index', index);

            // Renumber the name attributes for type and value inputs
            const typeInput = row.querySelector('input[name^="identifier_type_"], select[name^="identifier_type_"]');
            const valueInput = row.querySelector('input[name^="identifier_value_"]');

            if (typeInput) {
                const oldName = typeInput.getAttribute('name');
                typeInput.setAttribute('name', `identifier_type_${index}`);
            }
            if (valueInput) {
                const oldName = valueInput.getAttribute('name');
                valueInput.setAttribute('name', `identifier_value_${index}`);
            }
        });

        // Update the global counter to be one more than the last index
        identifierCount = rows.length;
    }

    function updateRemoveButtons() {
        const rows = document.querySelectorAll('.identifier-row');
        rows.forEach((row, index) => {
            const removeBtn = row.querySelector('.remove-identifier');
            if (!removeBtn) return; // Skip rows without remove button

            if (index === 0 && rows.length === 1) {
                removeBtn.style.display = 'none';
            } else {
                removeBtn.style.display = 'block';
            }
        });
    }

    // Initialize identifier options and remove button visibility
    updateIdentifierOptions();
    renumberIdentifiers(); // Renumber on page load to fix any gaps
    updateRemoveButtons();

    // Form validation - ensure at least one tag is selected
    const form = document.getElementById('property-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const tagCheckboxes = document.querySelectorAll('input[name="tags"]:checked');
            if (tagCheckboxes.length === 0) {
                e.preventDefault();
                alert('Please select at least one tag for this property. Every property must belong to at least one tag category.');
                return false;
            }
        });
    }
});
</script>
{% endblock %}
