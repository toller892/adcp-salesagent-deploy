{% extends "base.html" %}

{% block title %}Creative Review - {{ tenant_name }} - Sales Agent Admin{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>Creative Review - {{ tenant_name }}</h2>
        <div style="display: flex; gap: 0.5rem;">
            <a href="{{ url_for('creatives.list_creatives', tenant_id=tenant_id) }}" class="btn btn-secondary">View All Creatives</a>
            <a href="{{ url_for('tenants.dashboard', tenant_id=tenant_id) }}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
        </div>
    </div>

    <div class="alert alert-info">
        <strong>Review Queue:</strong> Review pending creatives and approve or reject them.
        {% if has_ai_review %}
        <span class="ai-badge">ü§ñ AI Review Enabled</span>
        {% endif %}
    </div>

    {% if creatives|length == 0 %}
    <!-- No pending creatives -->
    <div style="text-align: center; padding: 3rem; background: #f9f9f9; border-radius: 4px;">
        <div style="font-size: 4rem; margin-bottom: 1rem;">‚úÖ</div>
        <h3 style="color: #666; margin-bottom: 0.5rem;">All Caught Up!</h3>
        <p style="color: #999;">No creatives pending review at the moment.</p>
    </div>
    {% else %}
    <!-- Creatives Review Grid -->
    <div style="display: grid; gap: 2rem;">
        {% for creative in creatives %}
        <div class="review-card" id="creative-{{ creative.creative_id }}">
            <!-- Header -->
            <div class="review-header">
                <div>
                    <h3 style="margin: 0 0 0.5rem 0;">{{ creative.name }}</h3>
                    <p style="margin: 0; color: #666;">
                        <strong>Advertiser:</strong> {{ creative.principal_name }} |
                        <strong>Format:</strong> <span class="format-badge">{{ creative.format }}</span>
                    </p>
                    <p style="margin: 0.25rem 0 0 0; color: #666; font-size: 0.9rem;">
                        <strong>ID:</strong> <code style="background: #f4f4f4; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.85rem;">{{ creative.creative_id }}</code>
                        {% if creative.promoted_offering %}
                        | <strong>Promoted Offering:</strong> {{ creative.promoted_offering }}
                        {% endif %}
                    </p>
                    {% if creative.media_buy_name %}
                    <p style="margin: 0.25rem 0 0 0; color: #666; font-size: 0.9rem;">
                        <strong>Campaign:</strong> {{ creative.media_buy_name }}
                    </p>
                    {% endif %}
                </div>
                <span class="status-badge status-pending">Pending Review</span>
            </div>

            <!-- Preview Area -->
            <div class="preview-section">
                <h4 style="margin: 0 0 1rem 0;">Preview</h4>

                {% if creative.data.preview_response and creative.data.preview_response.previews %}
                    <!-- Multi-variant preview support (AdCP PR #119) -->
                    <div class="multi-preview-container" data-creative-id="{{ creative.creative_id }}">
                        {% set preview_data = creative.data.preview_response %}
                        {% set num_variants = preview_data.previews | length %}

                        {% if num_variants > 1 %}
                        <div class="preview-variant-selector">
                            <label style="font-weight: 500; color: #666; font-size: 0.9rem; margin-right: 0.5rem;">
                                Variant:
                            </label>
                            {% for variant_idx in range(num_variants) %}
                            <button class="variant-btn {% if variant_idx == 0 %}active{% endif %}"
                                    onclick="showVariant('{{ creative.creative_id }}', {{ variant_idx }})">
                                {% set variant = preview_data.previews[variant_idx] %}
                                {{ variant.preview_id or ('Variant ' ~ (variant_idx + 1)) }}
                            </button>
                            {% endfor %}
                        </div>
                        {% endif %}

                        {% for variant_idx, variant in enumerate(preview_data.previews) %}
                        <div class="preview-variant"
                             data-variant-index="{{ variant_idx }}"
                             style="{% if variant_idx != 0 %}display: none;{% endif %}">

                            {% if variant.renders | length > 1 %}
                            <div class="preview-render-selector">
                                <label style="font-weight: 500; color: #666; font-size: 0.85rem; margin-right: 0.5rem;">
                                    Render:
                                </label>
                                {% for render_idx in range(variant.renders | length) %}
                                <button class="render-btn {% if render_idx == 0 %}active{% endif %}"
                                        onclick="showRender('{{ creative.creative_id }}', {{ variant_idx }}, {{ render_idx }})">
                                    {% set render = variant.renders[render_idx] %}
                                    {{ render.role or render.render_id or ('Render ' ~ (render_idx + 1)) }}
                                </button>
                                {% endfor %}
                            </div>
                            {% endif %}

                            {% for render_idx, render in enumerate(variant.renders) %}
                            <div class="preview-render"
                                 data-render-index="{{ render_idx }}"
                                 style="{% if render_idx != 0 %}display: none;{% endif %}">
                                <div class="creative-preview" data-format="{{ creative.format }}">
                                    {% if render.preview_url %}
                                        {% if creative.format.startswith('display_') %}
                                            <div class="display-preview">
                                                {% if render.dimensions %}
                                                <div class="preview-dimensions">
                                                    {{ render.dimensions.width }}x{{ render.dimensions.height }}
                                                    {% if render.role %}
                                                    <span class="render-role-badge">{{ render.role }}</span>
                                                    {% endif %}
                                                </div>
                                                {% endif %}
                                                <img src="{{ render.preview_url }}"
                                                     alt="{{ creative.name }}"
                                                     style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px;">
                                            </div>
                                        {% elif creative.format.startswith('video_') %}
                                            <div class="video-preview">
                                                <video controls style="max-width: 100%; height: auto; border-radius: 4px;">
                                                    <source src="{{ render.preview_url }}" type="video/mp4">
                                                    Your browser does not support video playback.
                                                </video>
                                            </div>
                                        {% else %}
                                            <div class="generic-preview">
                                                <img src="{{ render.preview_url }}"
                                                     alt="{{ creative.name }}"
                                                     style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px;">
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <div style="text-align: center; padding: 2rem; background: #f8f9fa; border-radius: 4px;">
                                            <p style="margin: 0; color: #999;">No preview URL for this render.</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>

                {% elif creative.data.url %}
                    <!-- Fallback to legacy single preview -->
                    <div class="creative-preview" data-format="{{ creative.format }}">
                        {% if creative.format.startswith('display_') %}
                            <div class="display-preview">
                                {% if creative.data.width and creative.data.height %}
                                <div class="preview-dimensions">{{ creative.data.width }}x{{ creative.data.height }}</div>
                                {% endif %}
                                <img src="{{ creative.data.url }}"
                                     alt="{{ creative.name }}"
                                     style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        {% elif creative.format.startswith('video_') %}
                            <div class="video-preview">
                                <video controls style="max-width: 100%; height: auto; border-radius: 4px;">
                                    <source src="{{ creative.data.url }}" type="video/mp4">
                                    Your browser does not support video playback.
                                </video>
                            </div>
                        {% elif creative.format.startswith('native_') %}
                            <div class="native-preview">
                                <div class="native-card">
                                    {% if creative.data.image_url %}
                                    <img src="{{ creative.data.image_url }}"
                                         alt="{{ creative.data.title or creative.name }}"
                                         style="width: 100%; height: auto; border-radius: 4px 4px 0 0;">
                                    {% endif %}
                                    <div style="padding: 1rem;">
                                        <h4 style="margin: 0 0 0.5rem 0;">{{ creative.data.title or creative.name }}</h4>
                                        {% if creative.data.body %}
                                        <p style="margin: 0 0 0.5rem 0; color: #666;">{{ creative.data.body }}</p>
                                        {% endif %}
                                        {% if creative.data.cta_text %}
                                        <button class="btn btn-sm btn-primary" disabled>{{ creative.data.cta_text }}</button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="generic-preview">
                                <a href="{{ creative.data.url }}" target="_blank" class="btn btn-secondary">
                                    View Creative Asset ‚Üí
                                </a>
                            </div>
                        {% endif %}
                    </div>

                {% elif creative.data.snippet %}
                    <!-- HTML/Script snippet preview -->
                    <div class="snippet-preview">
                        <pre style="background: #f4f4f4; padding: 1rem; border-radius: 4px; overflow-x: auto;">{{ creative.data.snippet }}</pre>
                        <p style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                            <em>Note: Snippet type creatives cannot be fully previewed in the admin UI.</em>
                        </p>
                    </div>
                {% else %}
                    <!-- No preview available -->
                    <div style="text-align: center; padding: 2rem; background: #f8f9fa; border-radius: 4px;">
                        <p style="margin: 0; color: #999;">No preview available for this creative format.</p>
                    </div>
                {% endif %}

                <!-- Creative Details -->
                <div class="creative-details" style="margin-top: 1.5rem;">
                    <h4 style="margin: 0 0 0.5rem 0;">Details</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Creative ID:</span>
                            <span class="detail-value"><code>{{ creative.creative_id }}</code></span>
                        </div>
                        {% if creative.data.click_url %}
                        <div class="detail-item">
                            <span class="detail-label">Click URL:</span>
                            <span class="detail-value"><a href="{{ creative.data.click_url }}" target="_blank">{{ creative.data.click_url[:50] }}...</a></span>
                        </div>
                        {% endif %}
                        <div class="detail-item">
                            <span class="detail-label">Submitted:</span>
                            <span class="detail-value">{{ creative.created_at.strftime('%Y-%m-%d %H:%M UTC') if creative.created_at else 'N/A' }}</span>
                        </div>
                        {% if creative.data.file_size %}
                        <div class="detail-item">
                            <span class="detail-label">File Size:</span>
                            <span class="detail-value">{{ (creative.data.file_size / 1024) | round(2) }} KB</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- AI Review Section (if enabled) -->
            {% if has_ai_review %}
            <div class="ai-review-section" id="ai-review-{{ creative.creative_id }}" style="display: none;">
                <h4 style="margin: 0 0 0.5rem 0;">ü§ñ AI Review Result</h4>
                <div class="ai-result-content"></div>
            </div>
            {% endif %}

            <!-- Action Buttons -->
            <div class="review-actions">
                {% if has_ai_review %}
                <button class="btn btn-secondary" onclick="runAIReview('{{ creative.creative_id }}')">
                    ü§ñ Run AI Review
                </button>
                {% endif %}
                <button class="btn btn-success" onclick="approveCreative('{{ creative.creative_id }}')">
                    ‚úÖ Approve
                </button>
                <button class="btn btn-danger" onclick="showRejectModal('{{ creative.creative_id }}')">
                    ‚ùå Reject
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- Reject Modal -->
<div id="reject-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3 style="margin-top: 0;">Reject Creative</h3>
        <p>Please provide a reason for rejecting this creative. This will be sent back to the advertiser.</p>
        <textarea id="rejection-reason" rows="4" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" placeholder="Enter rejection reason..."></textarea>
        <div style="margin-top: 1rem; display: flex; justify-content: flex-end; gap: 0.5rem;">
            <button class="btn btn-secondary" onclick="closeRejectModal()">Cancel</button>
            <button class="btn btn-danger" onclick="confirmReject()">Confirm Rejection</button>
        </div>
    </div>
</div>

<style>
.ai-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
    margin-left: 0.5rem;
}

.review-card {
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    padding: 2rem;
    transition: box-shadow 0.2s;
}

.review-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.review-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    padding-bottom: 1.5rem;
    border-bottom: 2px solid #f0f0f0;
    margin-bottom: 1.5rem;
}

.status-badge {
    padding: 0.35rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    white-space: nowrap;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.format-badge {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    background: #e3f2fd;
    color: #1976d2;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 500;
}

.preview-section {
    margin-bottom: 1.5rem;
}

.creative-preview {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 4px;
    border: 1px solid #e0e0e0;
}

.display-preview {
    text-align: center;
}

.preview-dimensions {
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    color: #666;
    font-weight: 500;
}

.native-card {
    max-width: 400px;
    margin: 0 auto;
    background: white;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1rem;
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.detail-label {
    color: #666;
    font-weight: 500;
    font-size: 0.9rem;
}

.detail-value {
    color: #333;
    font-size: 0.95rem;
}

.detail-value a {
    color: #007bff;
    text-decoration: none;
}

.detail-value a:hover {
    text-decoration: underline;
}

.ai-review-section {
    padding: 1rem;
    background: #f0f4ff;
    border-left: 4px solid #667eea;
    border-radius: 4px;
    margin-bottom: 1.5rem;
}

.ai-result-content {
    margin-top: 0.5rem;
}

.review-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    padding-top: 1.5rem;
    border-top: 2px solid #f0f0f0;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
}

code {
    background: #f4f4f4;
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-size: 0.85rem;
}

/* Multi-variant preview support (AdCP PR #119) */
.preview-variant-selector,
.preview-render-selector {
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: white;
    border-radius: 4px;
    border: 1px solid #e0e0e0;
}

.variant-btn,
.render-btn {
    padding: 0.5rem 1rem;
    border: 1px solid #ddd;
    background: white;
    color: #666;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
    margin-right: 0.5rem;
}

.variant-btn:hover,
.render-btn:hover {
    background: #f8f9fa;
    border-color: #007bff;
}

.variant-btn.active,
.render-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.render-role-badge {
    display: inline-block;
    margin-left: 0.5rem;
    padding: 0.15rem 0.5rem;
    background: #e3f2fd;
    color: #1976d2;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}
</style>

<script>
let currentCreativeId = null;

// Multi-variant preview navigation (AdCP PR #119)
function showVariant(creativeId, variantIndex) {
    const container = document.querySelector(`.multi-preview-container[data-creative-id="${creativeId}"]`);
    if (!container) return;

    // Hide all variants
    container.querySelectorAll('.preview-variant').forEach(variant => {
        variant.style.display = 'none';
    });

    // Show selected variant
    const selectedVariant = container.querySelector(`.preview-variant[data-variant-index="${variantIndex}"]`);
    if (selectedVariant) {
        selectedVariant.style.display = 'block';
    }

    // Update active button
    container.querySelectorAll('.variant-btn').forEach((btn, idx) => {
        btn.classList.toggle('active', idx === variantIndex);
    });
}

function showRender(creativeId, variantIndex, renderIndex) {
    const container = document.querySelector(`.multi-preview-container[data-creative-id="${creativeId}"]`);
    if (!container) return;

    const variant = container.querySelector(`.preview-variant[data-variant-index="${variantIndex}"]`);
    if (!variant) return;

    // Hide all renders in this variant
    variant.querySelectorAll('.preview-render').forEach(render => {
        render.style.display = 'none';
    });

    // Show selected render
    const selectedRender = variant.querySelector(`.preview-render[data-render-index="${renderIndex}"]`);
    if (selectedRender) {
        selectedRender.style.display = 'block';
    }

    // Update active button
    variant.querySelectorAll('.render-btn').forEach((btn, idx) => {
        btn.classList.toggle('active', idx === renderIndex);
    });
}

function approveCreative(creativeId) {
    if (!confirm('Are you sure you want to approve this creative?')) {
        return;
    }

    fetch(`{{ script_name }}/tenant/{{ tenant_id }}/creatives/review/${creativeId}/approve`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            approved_by: 'admin'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Creative approved successfully!');
            document.getElementById(`creative-${creativeId}`).remove();

            // Reload if no more creatives
            if (document.querySelectorAll('.review-card').length === 0) {
                location.reload();
            }
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to approve creative: ' + error);
    });
}

function showRejectModal(creativeId) {
    currentCreativeId = creativeId;
    document.getElementById('reject-modal').style.display = 'flex';
    document.getElementById('rejection-reason').value = '';
    document.getElementById('rejection-reason').focus();
}

function closeRejectModal() {
    document.getElementById('reject-modal').style.display = 'none';
    currentCreativeId = null;
}

function confirmReject() {
    const reason = document.getElementById('rejection-reason').value.trim();

    if (!reason) {
        alert('Please provide a rejection reason.');
        return;
    }

    fetch(`{{ script_name }}/tenant/{{ tenant_id }}/creatives/review/${currentCreativeId}/reject`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            rejected_by: 'admin',
            rejection_reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚ùå Creative rejected. Advertiser will be notified.');
            document.getElementById(`creative-${currentCreativeId}`).remove();
            closeRejectModal();

            // Reload if no more creatives
            if (document.querySelectorAll('.review-card').length === 0) {
                location.reload();
            }
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to reject creative: ' + error);
    });
}

function runAIReview(creativeId) {
    const aiSection = document.getElementById(`ai-review-${creativeId}`);
    const aiContent = aiSection.querySelector('.ai-result-content');

    aiSection.style.display = 'block';
    aiContent.innerHTML = '<p style="margin: 0;"><em>Running AI review...</em></p>';

    fetch(`{{ script_name }}/tenant/{{ tenant_id }}/creatives/review/${creativeId}/ai-review`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const approved = data.approved;
            const reason = data.reason;
            const confidence = data.confidence;

            const emoji = approved ? '‚úÖ' : '‚ùå';
            const statusText = approved ? 'APPROVED' : 'REJECTED';
            const statusColor = approved ? '#28a745' : '#dc3545';

            aiContent.innerHTML = `
                <div style="background: white; padding: 1rem; border-radius: 4px; margin-top: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.5rem;">${emoji}</span>
                        <strong style="color: ${statusColor};">${statusText}</strong>
                        <span class="format-badge" style="background: #f0f0f0; color: #666;">Confidence: ${confidence}</span>
                    </div>
                    <p style="margin: 0; color: #666;">${reason}</p>
                </div>
            `;
        } else {
            aiContent.innerHTML = `<p style="margin: 0; color: #dc3545;"><strong>Error:</strong> ${data.error}</p>`;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        aiContent.innerHTML = `<p style="margin: 0; color: #dc3545;"><strong>Error:</strong> ${error}</p>`;
    });
}

// Close modal on escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape' && currentCreativeId) {
        closeRejectModal();
    }
});
</script>
{% endblock %}
