{% extends "base.html" %}

{% block title %}Inventory Browser - {{ tenant.name }} Sales Agent{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('core.index') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('tenants.tenant_settings', tenant_id=tenant.tenant_id) }}">{{ tenant.name }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">Inventory Browser</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-12">
            <h2>GAM Inventory Browser</h2>
            <p class="text-muted">Browse and manage Google Ad Manager inventory for {{ tenant.name }}</p>
        </div>
    </div>

    <!-- Sync Status -->
    <div class="row mt-3">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-1">Inventory Status</h5>
                            <p class="mb-0" id="syncStatus">Loading...</p>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="syncInventory()" id="syncBtn">
                                <i class="bi bi-arrow-clockwise"></i> Sync All
                            </button>
                            <button class="btn btn-outline-primary" onclick="showSelectiveSync()">
                                <i class="bi bi-sliders"></i> Selective
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Quick Stats</h5>
                    <div id="inventoryStats">
                        <div class="text-muted">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Explanation -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="alert alert-info">
                <h6 class="alert-heading">Understanding Inventory Types</h6>
                <ul class="mb-0">
                    <li><strong>Ad Units</strong> - The actual ad slots where ads are displayed (e.g., homepage banner, article sidebar)</li>
                    <li><strong>Placements</strong> - Groups of ad units that can be targeted together</li>
                    <li><strong>Custom Targeting</strong> - Key-value pairs for precise ad targeting (e.g., content_type=sports, user_segment=premium)</li>
                    <li><strong>Labels</strong> - Tags for organizing and categorizing inventory</li>
                </ul>
                <small class="d-block mt-2">The "All Inventory" view shows everything, while "Ad Units" filters to just the ad slots.</small>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Search Inventory</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchQuery"
                                   placeholder="Search by name or path...">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="inventoryType">
                                <option value="">All Types</option>
                                <option value="ad_unit">Ad Units</option>
                                <option value="placement">Placements</option>
                                <option value="label">Labels</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="inventoryStatus">
                                <option value="">All Status</option>
                                <option value="ACTIVE">Active</option>
                                <option value="INACTIVE">Inactive</option>
                                <option value="ARCHIVED">Archived</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="searchInventory()">
                                Search
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="row mt-4">
        <!-- Tree View -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Ad Unit Hierarchy</h5>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    <div id="adUnitTree" class="tree-view">
                        <div class="text-muted">Loading ad unit tree...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detail View -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Inventory Details</h5>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    <div id="inventoryDetail">
                        <p class="text-muted">Select an inventory item to view details</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Results -->
    <div class="row mt-4" id="searchResults" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Search Results</h5>
                </div>
                <div class="card-body">
                    <div id="searchResultsContent"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Assignment Modal -->
<div class="modal fade" id="assignProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign to Products</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">
                    <i class="bi bi-info-circle"></i>
                    Select multiple products to assign this inventory item to. Uncheck to remove existing assignments.
                </p>
                <div id="productList"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProductAssignment()">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.tree-view {
    font-family: monospace;
}

.tree-node {
    margin-left: 20px;
    cursor: pointer;
    user-select: none;
}

.tree-node:hover {
    background-color: #f0f0f0;
}

.tree-node.selected {
    background-color: #e3f2fd;
}

.tree-toggle {
    display: inline-block;
    width: 20px;
    text-align: center;
}

.node-icon {
    margin-right: 5px;
}

.node-status {
    font-size: 0.8em;
    margin-left: 10px;
}

.node-status.active { color: #28a745; }
.node-status.inactive { color: #6c757d; }
.node-status.archived { color: #dc3545; }

.inventory-size {
    display: inline-block;
    padding: 2px 8px;
    margin: 2px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 3px;
    font-size: 0.85em;
}

.search-result-item {
    padding: 10px;
    border-bottom: 1px solid #dee2e6;
    cursor: pointer;
}

.search-result-item:hover {
    background-color: #f8f9fa;
}
</style>

<script>
const tenantId = '{{ tenant.tenant_id }}';
let selectedInventory = null;
let inventoryTree = null;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check for URL parameters to pre-filter
    const urlParams = new URLSearchParams(window.location.search);
    const typeParam = urlParams.get('type');
    if (typeParam) {
        document.getElementById('inventoryType').value = typeParam;
    }

    loadInventoryStatus();

    // If type is specified, do initial search
    if (typeParam) {
        searchInventory();
    }
});

function loadInventoryStatus() {
    fetch(`{{ script_name }}/api/tenant/${tenantId}/inventory/tree`, {
        credentials: 'same-origin'
    })
        .then(response => response.json())
        .then(data => {
            const syncStatus = document.getElementById('syncStatus');
            const stats = document.getElementById('inventoryStats');

            if (data.last_sync) {
                const lastSync = new Date(data.last_sync);
                const now = new Date();
                const diffMs = now - lastSync;
                const diffMins = Math.floor(diffMs / (1000 * 60));
                const diffHours = Math.floor(diffMins / 60);
                const diffDays = Math.floor(diffHours / 24);

                let timeAgo;
                if (diffDays > 0) {
                    timeAgo = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
                } else if (diffHours > 0) {
                    timeAgo = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
                } else if (diffMins > 0) {
                    timeAgo = `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
                } else {
                    timeAgo = 'just now';
                }

                syncStatus.innerHTML = `
                    Last synced: ${lastSync.toLocaleString()}
                    <span class="text-muted">(${timeAgo})</span>
                    ${data.needs_refresh ? '<span class="badge bg-warning ms-2">Needs Refresh</span>' : ''}
                `;
            } else {
                syncStatus.innerHTML = '<span class="text-warning">Never synced</span>';
            }

            stats.innerHTML = `
                <div><strong>Ad Units:</strong> ${data.total_units || 0}</div>
                <div><strong>Placements:</strong> ${data.placements || 0}</div>
                <div><strong>Labels:</strong> ${data.labels || 0}</div>
                <div><strong>Targeting Keys:</strong> ${data.custom_targeting_keys || 0}</div>
                <div><strong>Audience Segments:</strong> ${data.audience_segments || 0}</div>
            `;

            inventoryTree = data;
            renderAdUnitTree(data.root_units || []);
        })
        .catch(error => {
            console.error('Error loading inventory status:', error);
            document.getElementById('syncStatus').innerHTML =
                '<span class="text-danger">Error loading status</span>';
        });
}

function syncInventory() {
    const btn = document.getElementById('syncBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Syncing...';

    fetch(`{{ script_name }}/api/tenant/${tenantId}/inventory/sync`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ mode: 'full' })
    })
        .then(response => {
            if (response.status === 202 || response.ok) {
                return response.json();
            }
            throw new Error(`Server error: ${response.status}`);
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }

            // Sync started in background
            if (data.sync_id && data.status === 'running') {
                alert(`‚úÖ Inventory sync started in background!\n\nSync ID: ${data.sync_id}\n\nThe page will reload automatically when sync completes. This may take a few minutes.`);

                // Poll for completion
                pollInventorySyncStatus(data.sync_id, btn);
            } else {
                throw new Error('Unexpected response format');
            }
        })
        .catch(error => {
            alert('Sync failed: ' + error.message);
            console.error('Sync error:', error);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Sync All';
        });
}

function pollInventorySyncStatus(syncId, btn) {
    const checkStatus = () => {
        fetch(`{{ script_name }}/tenant/${tenantId}/gam/sync-status/${syncId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'completed') {
                    // Sync completed - reload page
                    const summary = data.summary || {};
                    const adUnitCount = summary.ad_units?.total || 0;
                    const placementCount = summary.placements?.total || 0;
                    const labelCount = summary.labels?.total || 0;

                    alert(`‚úÖ Sync completed!\n\nAd Units: ${adUnitCount}\nPlacements: ${placementCount}\nLabels: ${labelCount}`);
                    window.location.reload();
                } else if (data.status === 'failed' || data.error) {
                    throw new Error(data.error || 'Sync failed');
                } else {
                    // Still running - check again in 2 seconds
                    setTimeout(checkStatus, 2000);
                }
            })
            .catch(error => {
                alert('Sync failed: ' + error.message);
                console.error('Sync error:', error);
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Sync All';
            });
    };

    checkStatus();
}

function renderAdUnitTree(units, container = null) {
    if (!container) {
        container = document.getElementById('adUnitTree');
        container.innerHTML = '';
    }

    if (units.length === 0) {
        container.innerHTML = '<p class="text-muted">No ad units found</p>';
        return;
    }

    units.forEach(unit => {
        const node = createTreeNode(unit);
        container.appendChild(node);
    });
}

function createTreeNode(unit) {
    const div = document.createElement('div');
    div.className = 'tree-node';
    div.dataset.unitId = unit.id;

    const hasChildren = unit.children && unit.children.length > 0;

    div.innerHTML = `
        <span class="tree-toggle" onclick="toggleNode(this, event)">
            ${hasChildren ? '‚ñº' : '&nbsp;'}
        </span>
        <span class="node-icon">üìÅ</span>
        <span class="node-name" onclick="selectNode('${unit.id}', event)">
            ${unit.name}
        </span>
        <span class="node-status ${unit.status.toLowerCase()}">[${unit.status}]</span>
    `;

    if (hasChildren) {
        const childContainer = document.createElement('div');
        childContainer.className = 'tree-children';
        childContainer.style.display = 'block';
        renderAdUnitTree(unit.children, childContainer);
        div.appendChild(childContainer);
    }

    return div;
}

function toggleNode(toggle, event) {
    event.stopPropagation();
    const node = toggle.parentElement;
    const children = node.querySelector('.tree-children');

    if (children) {
        if (children.style.display === 'none') {
            children.style.display = 'block';
            toggle.textContent = '‚ñº';
        } else {
            children.style.display = 'none';
            toggle.textContent = '‚ñ∂';
        }
    }
}

function selectNode(unitId, event) {
    event.stopPropagation();

    // Update selection
    document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('selected'));
    event.target.closest('.tree-node').classList.add('selected');

    // Find unit data
    const unit = findUnitById(inventoryTree.root_units, unitId);
    if (unit) {
        showInventoryDetail(unit, 'ad_unit');
    }
}

function findUnitById(units, unitId) {
    for (const unit of units) {
        if (unit.id === unitId) return unit;
        if (unit.children) {
            const found = findUnitById(unit.children, unitId);
            if (found) return found;
        }
    }
    return null;
}

function showInventoryDetail(item, type) {
    selectedInventory = { item, type };

    const detail = document.getElementById('inventoryDetail');

    let html = `
        <h6>${item.name}</h6>
        <table class="table table-sm">
            <tr><th>ID:</th><td>${item.id}</td></tr>
            <tr><th>Type:</th><td>${type}</td></tr>
            <tr><th>Status:</th><td><span class="badge bg-${getStatusColor(item.status)}">${item.status}</span></td></tr>
    `;

    if (item.path && item.path.length > 0) {
        html += `<tr><th>Path:</th><td>${item.path.join(' > ')}</td></tr>`;
    }

    // Sizes can be at top level (from tree API) or in metadata (from search API)
    const sizes = item.sizes || (item.metadata && item.metadata.sizes) || [];
    if (sizes.length > 0) {
        html += '<tr><th>Sizes:</th><td>';
        sizes.forEach(size => {
            html += `<span class="inventory-size">${size.width}x${size.height}</span>`;
        });
        html += '</td></tr>';
    }

    if (item.metadata) {
        if (item.metadata.ad_unit_code) {
            html += `<tr><th>Ad Unit Code:</th><td><code>${item.metadata.ad_unit_code}</code></td></tr>`;
        }

        if (item.metadata.explicitly_targeted) {
            html += `<tr><th>Targeting:</th><td>Explicitly Targeted</td></tr>`;
        }
    }

    html += '</table>';

    html += `
        <div class="mt-3">
            <button class="btn btn-sm btn-primary" onclick="assignToProduct()">
                Assign to Product
            </button>
            <button class="btn btn-sm btn-secondary" onclick="copyInventoryId('${item.id}')">
                Copy ID
            </button>
        </div>
    `;

    detail.innerHTML = html;
}

function getStatusColor(status) {
    switch (status) {
        case 'ACTIVE': return 'success';
        case 'INACTIVE': return 'secondary';
        case 'ARCHIVED': return 'danger';
        default: return 'info';
    }
}

function searchInventory() {
    const query = document.getElementById('searchQuery').value;
    const type = document.getElementById('inventoryType').value;
    const status = document.getElementById('inventoryStatus').value;

    const params = new URLSearchParams();
    if (query) params.append('q', query);
    if (type) params.append('type', type);
    if (status) params.append('status', status);

    fetch(`{{ script_name }}/api/tenant/${tenantId}/inventory/search?${params}`, {
        credentials: 'same-origin'
    })
        .then(response => response.json())
        .then(data => {
            showSearchResults(data.results);
        })
        .catch(error => {
            console.error('Search error:', error);
            alert('Search failed: ' + error.message);
        });
}

function showSearchResults(results) {
    const resultsDiv = document.getElementById('searchResults');
    const content = document.getElementById('searchResultsContent');

    if (results.length === 0) {
        content.innerHTML = '<p class="text-muted">No results found</p>';
    } else {
        let html = `<p>Found ${results.length} items</p>`;
        html += '<div class="list-group">';

        results.forEach(item => {
            html += `
                <div class="list-group-item search-result-item"
                     onclick="showInventoryDetail(${JSON.stringify(item).replace(/"/g, '&quot;')}, '${item.type}')">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">${item.name}</h6>
                            <p class="mb-1 text-muted">${item.path ? item.path.join(' > ') : ''}</p>
                            <small>Type: ${item.type} | Status: ${item.status}</small>
                        </div>
                        <div>
                            <span class="badge bg-${getStatusColor(item.status)}">${item.status}</span>
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        content.innerHTML = html;
    }

    resultsDiv.style.display = 'block';
}

async function assignToProduct() {
    if (!selectedInventory) return;

    try {
        // Load products and check for existing assignments
        const [productsResponse, ...assignmentResponses] = await Promise.all([
            fetch(`{{ script_name }}/api/tenant/${tenantId}/products`).then(r => r.json()),
            // Fetch assignments for all products to find which one has this inventory
            fetch(`{{ script_name }}/api/tenant/${tenantId}/products`).then(r => r.json())
                .then(data => {
                    // For each product, check if it has this inventory assigned
                    return Promise.all(
                        data.products.map(p =>
                            fetch(`{{ script_name }}/tenant/${tenantId}/products/${p.product_id}/inventory`)
                                .then(r => r.json())
                                .then(inv => ({ product_id: p.product_id, inventory: inv.inventory || [] }))
                                .catch(() => ({ product_id: p.product_id, inventory: [] }))
                        )
                    );
                })
        ]);

        const products = productsResponse.products;
        const assignments = assignmentResponses[0] || [];

        // Find which products have this inventory assigned
        const inventoryId = selectedInventory.item.id;
        const assignedProductIds = assignments
            .filter(a => a.inventory.some(inv => inv.inventory_id === inventoryId))
            .map(a => a.product_id);

        // Store mapping IDs for potential deletion
        const mappingsByProduct = {};
        assignments.forEach(a => {
            const mapping = a.inventory.find(inv => inv.inventory_id === inventoryId);
            if (mapping) {
                mappingsByProduct[a.product_id] = mapping.mapping_id;
            }
        });

        const productList = document.getElementById('productList');
        let html = '<div class="list-group">';

        products.forEach(product => {
            const isAssigned = assignedProductIds.includes(product.product_id);
            html += `
                <label class="list-group-item">
                    <input class="form-check-input me-1" type="checkbox"
                           name="productSelection" value="${product.product_id}"
                           data-mapping-id="${mappingsByProduct[product.product_id] || ''}"
                           ${isAssigned ? 'checked' : ''}>
                    <strong>${product.name}</strong>
                    ${isAssigned ? '<span class="badge bg-success ms-2">Currently Assigned</span>' : ''}
                    <small class="text-muted d-block">${product.description || 'No description'}</small>
                </label>
            `;
        });

        html += '</div>';
        productList.innerHTML = html;

        new bootstrap.Modal(document.getElementById('assignProductModal')).show();
    } catch (error) {
        console.error('Error loading products:', error);
        alert('Failed to load products');
    }
}

async function saveProductAssignment() {
    if (!selectedInventory) return;

    const inventoryItem = selectedInventory.item;
    const inventoryType = selectedInventory.type;

    // Get all checkboxes and their current state
    const allCheckboxes = document.querySelectorAll('input[name="productSelection"]');

    // Determine adds and removes based on checkbox state
    const toAdd = [];
    const toRemove = [];

    allCheckboxes.forEach(cb => {
        const productId = cb.value;
        const mappingId = cb.dataset.mappingId;
        const wasAssigned = !!mappingId; // Had a mapping ID means it was previously assigned
        const isNowChecked = cb.checked;

        if (!wasAssigned && isNowChecked) {
            // New assignment
            toAdd.push(productId);
        } else if (wasAssigned && !isNowChecked) {
            // Remove assignment
            toRemove.push({ productId, mappingId });
        }
    });

    if (toAdd.length === 0 && toRemove.length === 0) {
        alert('No changes to save');
        return;
    }

    try {
        const results = [];

        // Add new assignments
        for (const productId of toAdd) {
            const response = await fetch(`/tenant/{{ tenant_id }}/products/${productId}/inventory`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    inventory_id: inventoryItem.id,
                    inventory_type: inventoryType,
                    is_primary: false
                })
            });
            const data = await response.json();
            if (data.error) {
                results.push(`‚ùå Failed to add: ${data.error}`);
            } else {
                results.push(`‚úì Added to 1 product`);
            }
        }

        // Remove old assignments
        for (const { productId, mappingId } of toRemove) {
            const response = await fetch(`/tenant/{{ tenant_id }}/products/${productId}/inventory/${mappingId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();
            if (!data.success) {
                results.push(`‚ùå Failed to remove: ${data.message || 'Unknown error'}`);
            } else {
                results.push(`‚úì Removed from 1 product`);
            }
        }

        const summary = `Changes saved:\n‚Ä¢ ${toAdd.length} product(s) added\n‚Ä¢ ${toRemove.length} product(s) removed`;
        alert(summary);

        bootstrap.Modal.getInstance(document.getElementById('assignProductModal')).hide();

        // Refresh the display
        showInventoryDetail(inventoryItem, inventoryType);
    } catch (error) {
        console.error('Error saving assignments:', error);
        alert('Failed to save assignments');
    }
}

function copyInventoryId(id) {
    navigator.clipboard.writeText(id).then(() => {
        alert('Inventory ID copied to clipboard!');
    });
}

// Selective sync modal
function showSelectiveSync() {
    new bootstrap.Modal(document.getElementById('selectiveSyncModal')).show();
}

function performSelectiveSync() {
    const types = [];
    if (document.getElementById('sync_ad_units').checked) types.push('ad_units');
    if (document.getElementById('sync_placements').checked) types.push('placements');
    if (document.getElementById('sync_labels').checked) types.push('labels');
    if (document.getElementById('sync_custom_targeting').checked) types.push('custom_targeting');
    if (document.getElementById('sync_audience_segments').checked) types.push('audience_segments');

    if (types.length === 0) {
        alert('Please select at least one inventory type to sync');
        return;
    }

    const customTargetingLimit = document.getElementById('custom_targeting_limit').value;
    const audienceSegmentLimit = document.getElementById('audience_segment_limit').value;

    const requestBody = { types };
    if (customTargetingLimit) requestBody.custom_targeting_limit = parseInt(customTargetingLimit);
    if (audienceSegmentLimit) requestBody.audience_segment_limit = parseInt(audienceSegmentLimit);

    const btn = document.getElementById('selectiveSyncBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Syncing...';

    fetch(`{{ script_name }}/api/tenant/${tenantId}/inventory/sync`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody)
    })
        .then(async response => {
            // Check HTTP status first before parsing JSON
            if (!response.ok) {
                // Try to parse error message from JSON response
                try {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                } catch (e) {
                    // If JSON parsing fails, use status text
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }

            let message = 'Selective sync completed!\n\n';
            if (data.ad_units) message += `Ad Units: ${data.ad_units.total}\n`;
            if (data.placements) message += `Placements: ${data.placements.total}\n`;
            if (data.labels) message += `Labels: ${data.labels.total}\n`;
            if (data.custom_targeting) message += `Custom Targeting Keys: ${data.custom_targeting.total_keys} (values lazy-loaded per key)\n`;
            if (data.audience_segments) message += `Audience Segments: ${data.audience_segments.total}\n`;
            message += `\nDuration: ${data.duration_seconds.toFixed(2)}s`;

            alert(message);

            // Close modal and reload
            bootstrap.Modal.getInstance(document.getElementById('selectiveSyncModal')).hide();
            window.location.reload();
        })
        .catch(error => {
            alert('Selective sync failed: ' + error.message);
            console.error('Selective sync error:', error);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = 'Sync Selected';
        });
}

// Add enter key support for search
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('searchQuery').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchInventory();
        }
    });
});
</script>

<!-- Selective Sync Modal -->
<div class="modal fade" id="selectiveSyncModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Selective Inventory Sync</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Select which inventory types to sync. Use limits for large datasets to reduce sync time.</p>

                <div class="mb-3">
                    <h6>Inventory Types</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="sync_ad_units" checked>
                        <label class="form-check-label" for="sync_ad_units">
                            <strong>Ad Units</strong> - Ad slots where ads are displayed
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="sync_placements" checked>
                        <label class="form-check-label" for="sync_placements">
                            <strong>Placements</strong> - Groups of ad units
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="sync_labels" checked>
                        <label class="form-check-label" for="sync_labels">
                            <strong>Labels</strong> - Organization tags
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="sync_custom_targeting" checked>
                        <label class="form-check-label" for="sync_custom_targeting">
                            <strong>Custom Targeting</strong> - Key-value pairs for targeting
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="sync_audience_segments" checked>
                        <label class="form-check-label" for="sync_audience_segments">
                            <strong>Audience Segments</strong> - First/third-party audiences
                        </label>
                    </div>
                </div>

                <div class="mb-3">
                    <h6>Limits (Optional)</h6>
                    <small class="text-muted d-block mb-2">For publishers with 10K+ targeting values/segments, use limits to speed up sync</small>

                    <div class="row">
                        <div class="col-md-6">
                            <label for="custom_targeting_limit" class="form-label">Custom Targeting Values (per key)</label>
                            <input type="number" class="form-control" id="custom_targeting_limit" placeholder="e.g., 1000">
                        </div>
                        <div class="col-md-6">
                            <label for="audience_segment_limit" class="form-label">Audience Segments</label>
                            <input type="number" class="form-control" id="audience_segment_limit" placeholder="e.g., 500">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="selectiveSyncBtn" onclick="performSelectiveSync()">
                    Sync Selected
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
